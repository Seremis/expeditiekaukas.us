
/**
 * Called when the google maps api code has loaded (happens async). This initializes a map with the muted blue style.
 */
function initMap() {
    var styledMapType = new google.maps.StyledMapType([{"featureType":"all","stylers":[{"saturation":0},{"hue":"#e7ecf0"}]},{"featureType":"road","stylers":[{"saturation":-70}]},{"featureType":"transit","stylers":[{"visibility":"off"}]},{"featureType":"poi","stylers":[{"visibility":"off"}]},{"featureType":"water","stylers":[{"visibility":"simplified"},{"saturation":-60}]}], {name: "{{ mapslayoutName}}"});

    var mapProp= {
        center:new google.maps.LatLng(39.6006623,45.7051961),
        zoom:7,
        mapTypeControlOptions: {
            mapTypeIds: ['roadmap', 'satellite', 'hybrid', 'terrain',
                'styled_map']
        }
    };

    var map=new google.maps.Map(document.getElementById("map"),mapProp);

    map.mapTypes.set('styled_map', styledMapType);
    map.setMapTypeId('styled_map');


    loadRoutes(map);
}

function loadRoutes(map) {
    console.log("Loading people...")
    getPeople(
        successCallback = function(data) {
            console.log("Loading people succeeded!")

            $.each( data.people, function(key, val) {
                console.log("Requesting route for " + val);

                getRoute(val,
                    successCallback = function(data) {
                        console.log("Loading route for " + data.personName + " succeeded!");

                        drawRouteOnMap(map, data);
                    },
                    errorCallback = function(data) {
                        alert("{{ errorLoadingTryAgain }}")
                    }
                );
            });
        },
        errorCallback = function (data) {
            alert("{{ errorLoadingTryAgain }}")
        }
    );
}


function getPeople(successCallback, errorCallback) {
    $.getJSON({
        url: "https://expeditiekaukas.us/api/person",
        success: successCallback,
        error: errorCallback
    });
}

function getRoute(personName, successCallback, errorCallback) {
    $.getJSON({
        url: "https://expeditiekaukas.us/api/route/" + personName,
        success: successCallback,
        error: errorCallback
    });
}

function drawRouteOnMap(map, json) {
    var bounds = new google.maps.LatLngBounds();

    var personName = json.personName;
    var lastSeenStamp = json.lastUpdateTime;
    var lastSeenZoneOffset = json.lastUpdateTimezoneOffset;
    var route = json.route;

    console.log(personName + " route length: " + route.length);

    var polyline = new google.maps.Polyline({
        strokeColor: '#9b0000',
        strokeOpacity: 1.0,
        strokeWeight: 3
    });

    for(var i = 0; i < route.length; i++) {
        var location = new google.maps.LatLng(route[i].lat, route[i].lon)

        polyline.getPath().push(location);
        bounds.extend(location)
    }

    polyline.setMap(map);
    map.fitBounds(bounds);
}

function formatDate(d) {
    Number.prototype.padLeft = function(base,chr){
        var  len = (String(base || 10).length - String(this).length)+1;
        return len > 0? new Array(len).join(chr || '0')+this : this;
    }

    return [    d.getDate().padLeft(),
                (d.getMonth()+1).padLeft(),
                d.getFullYear(),
                ].join('/') +' ' +
                [d.getHours().padLeft(),
                d.getMinutes().padLeft(),
                d.getSeconds().padLeft()].join(':');
}